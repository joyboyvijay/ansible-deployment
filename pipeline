pipeline {
    agent any

    options {
        ansiColor('xterm')
        timestamps()
    }

    environment {
        // Disable strict host key checking so first-time SSH doesnâ€™t block
        ANSIBLE_HOST_KEY_CHECKING = 'False'
    }

    stages {

        stage('Checkout Ansible Repo') {
            steps {
                // Clean workspace to avoid stale files/paths
                deleteDir()
                git branch: 'main',
                    credentialsId: 'vijaypassid',
                    url: 'https://github.com/joyboyvijay/ansible-deployment.git'
            }
        }

        stage('Checkout Website Repo') {
            steps {
                dir('web-src') {
                    git branch: 'main',
                        credentialsId: 'vijaypassid',
                        url: 'https://github.com/joyboyvijay/webfiles.git'
                }
            }
        }

        stage('Sanity: Show Workspace') {
            steps {
                sh '''
                  echo "[SANITY] Workspace layout"
                  pwd
                  echo "--- ROOT ---"
                  ls -la
                  echo "--- web-src ---"
                  ls -la web-src || true

                  echo "[SANITY] Ansible version"
                  ansible --version || true
                '''
            }
        }

        stage('Debug: Validate Inventory') {
            steps {
                sh '''
                  echo "[DEBUG] Check inventory folder and file"
                  ls -l inventory || true

                  echo "[DEBUG] Show inventory/hosts.ini (first 120 lines)"
                  sed -n '1,120p' inventory/hosts.ini || true

                  echo "[DEBUG] File type (to detect CRLF)"
                  file -b inventory/hosts.ini || true

                  # Convert Windows CRLF to Unix LF if present
                  if file -b inventory/hosts.ini | grep -qi 'CRLF'; then
                    echo "[DEBUG] Converting CRLF -> LF in inventory/hosts.ini"
                    sed -i 's/\\r$//' inventory/hosts.ini
                    echo "[DEBUG] After convert:"
                    file -b inventory/hosts.ini
                  fi

                  echo "[DEBUG] ansible-inventory parse test"
                  ansible-inventory -i inventory/hosts.ini --list | head -n 80 || true
                '''
            }
        }

        stage('Deploy with Ansible') {
            steps {
                // If your 'ubuntu' user needs a sudo password, wrap this block with withCredentials:
                // withCredentials([string(credentialsId: 'becomePassId', variable: 'BECOME_PASS')]) { ... }
                ansiblePlaybook(
                    playbook: 'deploy.yml',
                    // IMPORTANT: use the correct path you actually have in the repo
                    inventory: 'inventory/hosts.ini',
                    colorized: true,
                    credentialsId: 'vijaysshid',    // SSH key for the two VMs
                    extraVars: [
                        // Pass absolute path so 'copy' can find index.html reliably
                        web_src: "${WORKSPACE}/web-src"
                        // If sudo password is required on targets, also pass:
                        // ansible_become_password: "${BECOME_PASS}"
                    ],
                    // Extra verbosity helps diagnose connectivity/sudo issues
                    extras: '-vvvv'
                )
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed.'
            // If you want to archive a log, you must create it yourself (the Ansible plugin does not pipe to tee).
            // For now, keep this disabled to avoid false failures:
            // archiveArtifacts artifacts: 'ansible.log', onlyIfSuccessful: false
        }
    }
}
